


App.Modules.Commerce = class extends Colibri.Modules.Module {

    _mainFrame = null;

    /** @constructor */
    constructor() {
        super('Commerce');
        
    }

    InitializeModule() {
        console.log('Initializing module Commerce');
        
        this._store = App.Store.AddChild('app.commerce', {});
        this._store.AddPathLoader('commerce.menu', 'Commerce:Commerce.Menu');
        this._store.AddPathLoader('commerce.settings', 'Commerce:Commerce.Settings');
        this._store.AddPathLoader('commerce.page', () => this.Page(App.Router?.current ?? '/', App.Router?.options ?? {}, true));
        
    }

    Render() {
        console.log('Rendering Module Commerce');    
        
        App.Router.AddRoutePattern('/', (url, options) => {
            url = url.urlinfo();
            this.SelectMenuItem(url.url, url.options);
            return false;
        });
        
        this.MainFrame.Show();
    }

    RegisterEvents() {
        console.log('Registering module events for Commerce');
    }

    RegisterEventHandlers() {
        console.log('Registering event handlers for Commerce');
    }

    get MainFrame() {
        if(!this._mainFrame) {
            this._mainFrame = new App.Modules.Commerce.MainFrame('mainframe', document.body);
        }
        return this._mainFrame;e
    }

    ShowRegisterWindow() {
        if(!this._registerWindow) {
            this._registerWindow = new App.Modules.Commerce.RegisterWindow('register', document.body);
        }
        this._registerWindow.Show();
    }

    ShowLoginWindow() {
        if(!this._loginWindow) {
            this._loginWindow = new App.Modules.Commerce.LoginWindow('login', document.body);
        }
        this._loginWindow.Show();
    }


    SelectMenuItem(url, options) {
        const parts = url.trim('/').split('/');
        let parent = null;
        let selected = null;
        this._store.AsyncQuery('commerce.menu').then((data) => {

            data.forEach(d => d.selected = false);

            for(const part of parts) {
                const found = data.filter(d => (d?.parent?.id ?? null)==parent && d.name==part);
                selected = found[0];
                parent = selected?.id;
            }

            if(selected) {
                selected.selected = true;
            }

            this._store.Set('commerce.menu', data);

            const wnd = selected?.parameters?.window;
            if(wnd) {
                const wndObject = eval(wnd);
                const w = new wndObject('modal', document.body);
                w.AddHandler('WindowClosed', (event, args) => w.Dispose());
                w.Show();

                this.Page('/', {}, false);

            }
            else {
                this.Page(url, options, false);
            }

        });
    }

    Page(route, options, page = 1, pagesize = 100, returnPromise = false) {
        const promise = this.Call('Commerce', 'Page', {folder: route, options: options, page: page, pagesize: pagesize});
        if(returnPromise) {
            return promise;
        }
        promise.then((response) => {
            this._store.Set('commerce.page', response.result);
        }).catch((error) => App.Notices.Add(new Colibri.UI.Notice(error.result)));
    }

}

App.Modules.Commerce.Icons = {};
App.Modules.Commerce.Icons.CommerceSettingsIcon =           '<svg width="28" height="27" viewBox="0 0 28 27" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M21.3549 17.5C21.3549 18.4941 20.5244 19.3 19.5 19.3C18.4756 19.3 17.6452 18.4941 17.6452 17.5C17.6452 16.5059 18.4756 15.7 19.5 15.7C20.5244 15.7 21.3549 16.5059 21.3549 17.5ZM20.4274 17.5C20.4274 17.9971 20.0122 18.4 19.5 18.4C18.9878 18.4 18.5726 17.9971 18.5726 17.5C18.5726 17.0029 18.9878 16.6 19.5 16.6C20.0122 16.6 20.4274 17.0029 20.4274 17.5Z" fill="#2E3A59"/><path fill-rule="evenodd" clip-rule="evenodd" d="M15.0621 15.9593L15.9061 14.5407C16.0151 14.3575 16.2408 14.2727 16.4484 14.3369L17.3002 14.6001C17.4139 14.519 17.5318 14.4446 17.6534 14.3771C17.7691 14.3124 17.8888 14.2537 18.012 14.2013L18.203 13.3538C18.2496 13.1472 18.4381 13 18.656 13H20.344C20.562 13 20.7505 13.1472 20.797 13.3538L20.9881 14.2013C21.1188 14.2569 21.2456 14.3196 21.3679 14.389C21.4819 14.4533 21.5927 14.5237 21.6998 14.6001L22.5516 14.3369C22.7592 14.2727 22.9849 14.3575 23.0939 14.5407L23.9379 15.9593C24.0468 16.1425 24.0097 16.3745 23.8486 16.5169L23.1878 17.1012C23.203 17.234 23.2104 17.3669 23.2103 17.4995C23.2105 17.6324 23.203 17.7657 23.1878 17.8988L23.8486 18.4831C24.0097 18.6255 24.0468 18.8575 23.9379 19.0407L23.0939 20.4593C22.9849 20.6425 22.7592 20.7273 22.5516 20.6631L21.6998 20.3999C21.5914 20.4772 21.4792 20.5484 21.3637 20.6134C21.2427 20.6818 21.1173 20.7437 20.9881 20.7987L20.797 21.6462C20.7505 21.8528 20.562 22 20.344 22H18.656C18.4381 22 18.2496 21.8528 18.203 21.6462L18.012 20.7987C17.8902 20.7469 17.7719 20.6889 17.6574 20.6252C17.5345 20.5571 17.4152 20.4819 17.3002 20.3999L16.4484 20.6631C16.2408 20.7273 16.0151 20.6425 15.9061 20.4593L15.0621 19.0407C14.9532 18.8575 14.9903 18.6255 15.1514 18.4831L15.8122 17.8988C15.797 17.7659 15.7896 17.6327 15.7897 17.5C15.7896 17.3673 15.797 17.2341 15.8122 17.1012L15.1514 16.5169C14.9903 16.3745 14.9532 16.1425 15.0621 15.9593ZM19.9708 13.9L20.183 14.8415L20.6157 15.0256C20.7136 15.0672 20.8085 15.1142 20.9003 15.1662L20.9018 15.167C20.9872 15.2152 21.0702 15.268 21.1504 15.3252L21.531 15.5968L22.4773 15.3044L22.9481 16.0956L22.214 16.7448L22.266 17.2004C22.2774 17.2998 22.283 17.3994 22.2829 17.4988L22.2829 17.5005C22.283 17.6001 22.2774 17.7 22.266 17.7996L22.214 18.2552L22.9481 18.9044L22.4773 19.6956L21.531 19.4032L21.1504 19.6748C21.0693 19.7327 20.9852 19.7861 20.8986 19.8348L20.8971 19.8356C20.8064 19.8869 20.7125 19.9333 20.6157 19.9744L20.183 20.1585L19.9708 21.1H19.0293L18.817 20.1585L18.3844 19.9744C18.2932 19.9356 18.2046 19.8922 18.1187 19.8444L18.1172 19.8436C18.025 19.7925 17.9357 19.7362 17.8496 19.6748L17.469 19.4032L16.5227 19.6956L16.0519 18.9044L16.786 18.2552L16.734 17.7996C16.7226 17.7001 16.717 17.6004 16.7171 17.5008L16.7171 17.4992C16.717 17.3996 16.7226 17.2999 16.734 17.2004L16.786 16.7448L16.0519 16.0956L16.5227 15.3044L17.469 15.5968L17.8496 15.3252C17.9347 15.2645 18.0231 15.2087 18.1142 15.1581L18.1157 15.1572C18.2025 15.1088 18.2922 15.0648 18.3844 15.0256L18.817 14.8415L19.0293 13.9H19.9708Z" fill="#2E3A59"/><path d="M19.8855 6.77831L18.6364 5.06075V4.62499C18.6364 4.27981 18.3311 4 17.9546 4H7.04546C6.6689 4 6.36365 4.27981 6.36365 4.62499V5.06075L5.11451 6.77831C5.03985 6.88097 5 7.00161 5 7.12501V8.37502C5 8.92817 5.26383 9.42651 5.68181 9.77022V18.375C5.68184 18.7202 5.98709 19 6.36365 19H12.5H15.9091H18.6364C19.0129 19 19.3182 19 19.3182 19V9.77022C19.7362 9.42651 20 8.92817 20 8.37502V7.12501C20 7.00161 19.9602 6.88097 19.8855 6.77831ZM6.36365 7.31424L7.61278 5.59668C7.68744 5.49402 7.7273 5.37338 7.7273 5.24998H17.2728C17.2728 5.37338 17.3126 5.49399 17.3873 5.59668L18.6364 7.31424V8.37499C18.6364 8.5854 18.5196 8.77296 18.3431 8.88648C18.3261 8.89401 18.3091 8.90201 18.2923 8.91101C18.1997 8.96061 18.1048 8.98937 18.0091 8.9974C17.9911 8.99875 17.973 8.99998 17.9545 8.99998C17.5811 8.99998 17.2727 8.71729 17.2727 8.37499V7.12498H15.9091V8.37499C15.9091 8.71732 15.6007 8.99998 15.2273 8.99998C14.8538 8.99998 14.5455 8.71729 14.5455 8.37499V7.12498H13.1818V8.37499C13.1818 8.71732 12.8734 8.99998 12.5 8.99998C12.1266 8.99998 11.8182 8.71729 11.8182 8.37499V7.12498H10.4546V8.37499C10.4546 8.71732 10.1462 8.99998 9.77275 8.99998C9.3993 8.99998 9.09094 8.71729 9.09094 8.37499V7.12498H7.7273V8.37499C7.7273 8.71732 7.41891 8.99998 7.04549 8.99998C7.02708 8.99998 7.00896 8.99875 6.9909 8.9974C6.89531 8.98937 6.80029 8.96061 6.7077 8.91101C6.69092 8.90201 6.67395 8.89401 6.65692 8.88648C6.4804 8.77296 6.36365 8.5854 6.36365 8.37499V7.31424ZM13.1818 19V12.375H19.3182V19H13.1818ZM17.9546 11.125H15.9091H12.5C12.1235 11.125 11.8182 11.4048 11.8182 11.75V17.75H7.04546V10.25C7.56849 10.25 8.04677 10.0685 8.4091 9.77058C8.77144 10.0685 9.24972 10.25 9.77275 10.25C10.2958 10.25 10.7741 10.0685 11.1364 9.77058C11.4987 10.0685 11.977 10.25 12.5 10.25C13.0231 10.25 13.5014 10.0685 13.8637 9.77058C14.226 10.0685 14.7043 10.25 15.2273 10.25C15.7504 10.25 16.2287 10.0685 16.591 9.77058C16.9533 10.0685 17.4316 10.25 17.9546 10.25L17.9546 11.125Z" fill="#2E3A59"/><path d="M11.8788 15.0833H9.29926V18.25H11.8788V15.0833Z" fill="#2E3A59"/></svg>';
App.Modules.Commerce.Icons.CatalogueIcon =                  '<svg width="28" height="27" viewBox="0 0 28 27" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M23.7723 7.51919L22.197 5.34362V4.79165C22.197 4.35443 21.812 4 21.3372 4H7.57955C7.10467 4 6.71971 4.35443 6.71971 4.79165V5.34362L5.14441 7.51919C5.05026 7.64922 5 7.80204 5 7.95834V9.54169C5 10.2424 5.33272 10.8736 5.85984 11.3089V22.2083C5.85988 22.6456 6.24483 23 6.71971 23H14.4584H18.7576H22.197C22.6719 23 23.0568 22.6456 23.0568 22.2083V11.3089C23.584 10.8736 23.9167 10.2424 23.9167 9.54169V7.95834C23.9167 7.80204 23.8665 7.64922 23.7723 7.51919ZM6.71971 8.19803L8.29501 6.02246C8.38916 5.89243 8.43942 5.73961 8.43942 5.58331H20.4773C20.4773 5.73961 20.5276 5.89239 20.6217 6.02246L22.197 8.19803V9.54165C22.197 9.80817 22.0498 10.0457 21.8272 10.1895C21.8056 10.1991 21.7843 10.2092 21.7631 10.2206C21.6463 10.2834 21.5266 10.3199 21.406 10.33C21.3832 10.3317 21.3603 10.3333 21.3371 10.3333C20.8662 10.3333 20.4773 9.97524 20.4773 9.54165V7.95831H18.7576V9.54165C18.7576 9.97528 18.3687 10.3333 17.8977 10.3333C17.4268 10.3333 17.0379 9.97524 17.0379 9.54165V7.95831H15.3182V9.54165C15.3182 9.97528 14.9293 10.3333 14.4584 10.3333C13.9874 10.3333 13.5985 9.97524 13.5985 9.54165V7.95831H11.8788V9.54165C11.8788 9.97528 11.4899 10.3333 11.019 10.3333C10.548 10.3333 10.1591 9.97524 10.1591 9.54165V7.95831H8.43942V9.54165C8.43942 9.97528 8.05052 10.3333 7.57959 10.3333C7.55637 10.3333 7.53352 10.3317 7.51075 10.33C7.39019 10.3199 7.27037 10.2834 7.1536 10.2206C7.13244 10.2092 7.11104 10.1991 7.08955 10.1895C6.86695 10.0457 6.71971 9.80817 6.71971 9.54165V8.19803ZM15.3182 21.4167V15.875H17.8977V21.4167H15.3182V21.4167ZM21.3372 21.4167H19.6175V15.0833C19.6175 14.6461 19.2325 14.2917 18.7576 14.2917H14.4584C13.9835 14.2917 13.5985 14.6461 13.5985 15.0833V21.4167H7.57955V11.9167C8.23915 11.9167 8.84232 11.6867 9.29926 11.3094C9.7562 11.6867 10.3594 11.9167 11.019 11.9167C11.6786 11.9167 12.2817 11.6867 12.7387 11.3094C13.1956 11.6867 13.7988 11.9167 14.4584 11.9167C15.118 11.9167 15.7212 11.6867 16.1781 11.3094C16.6351 11.6867 17.2382 11.9167 17.8978 11.9167C18.5574 11.9167 19.1606 11.6867 19.6175 11.3094C20.0745 11.6867 20.6776 11.9167 21.3372 11.9167V21.4167H21.3372Z" fill="#2E3A59"/><path d="M11.8788 15.0833H9.29926V18.25H11.8788V15.0833Z" fill="#2E3A59"/></svg>';
App.Modules.Commerce.Icons.ProductsIcon =                   '<svg width="28" height="27" viewBox="0 0 28 27" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M13.5833 22L6.5 18.2895V15.0553L11 17.6096L13.5833 14.8229V22ZM14.4167 21.9992V14.7943L17.0517 17.5295L21.5 15.1093V18.2895L14.4167 21.9992ZM5.80083 13.7151L4 12.6973L6.5 9.99564L4 7.68591L11.265 4L13.9442 5.95136L16.715 4L24 7.73173L21.5042 9.99891L24 12.8159L22.1317 13.8313V13.8305L17.2125 16.5059L14.4225 13.6087L20.6025 10.3671L14.0008 6.79L7.39833 10.3671L13.5833 13.5883V13.6079L10.8358 16.5714L6.5 14.1103L6.36667 14.035L5.80083 13.7135V13.7151V13.7151Z" fill="#2E3A59"/></svg>';

const Commerce = new App.Modules.Commerce();

